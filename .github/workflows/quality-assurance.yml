name: Quality Assurance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read

jobs:
  test-coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
      with:
        platform: ubuntu
    
    - name: Install coverage tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcovr lcov googletest libgtest-dev
        cd /usr/src/googletest
        sudo cmake CMakeLists.txt
        sudo make
        sudo cp lib/*.a /usr/lib
    
    - name: Configure and build with coverage
      run: |
        mkdir -p tmp/builds/coverage tmp/tests
        cd tmp/builds/coverage
        cmake ../../.. -G Ninja -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage" -DCMAKE_C_FLAGS="--coverage"
        ninja
    
    - name: Run tests with coverage
      run: |
        cd tmp/builds/coverage
        if [ -f "stabilizer_tests" ]; then
          ./stabilizer_tests
        else
          echo "Test executable not found, skipping test run"
          ls -la
        fi
    
    - name: Generate coverage report
      run: |
        gcovr --root . --html --html-details -o tmp/coverage-report.html || echo "gcovr HTML generation failed, continuing"
        gcovr --root . --xml -o tmp/coverage.xml || echo "gcovr XML generation failed, continuing"
        lcov --capture --directory . --output-file tmp/coverage.info --ignore-errors mismatch --ignore-errors empty || echo "lcov capture failed, continuing" 
        lcov --remove tmp/coverage.info '/usr/*' --output-file tmp/coverage.info --ignore-errors empty || echo "lcov filtering failed, continuing"
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports-${{ github.run_number }}
        retention-days: 14
        path: |
          tmp/coverage-report.html
          tmp/coverage.xml
          tmp/coverage.info

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
      with:
        platform: ubuntu
    
    - name: Install static analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck
    
    - name: Run static analysis
      run: |
        mkdir -p tmp/static-analysis
        cppcheck --enable=all --xml --xml-version=2 --output-file=tmp/static-analysis/cppcheck.xml src/
        cppcheck --enable=all --template=gcc src/ > tmp/static-analysis/cppcheck.txt 2>&1 || true
    
    - name: Upload static analysis reports
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-reports-${{ github.run_number }}
        retention-days: 14
        path: tmp/static-analysis/
