# OBS Stabilizer - Architecture Design

## 1. 機能要件 (Functional Requirements)

### 1.1. コア機能
- **リアルタイム映像スタビライゼーション**: OBSのビデオソースに適用し、カメラの揺れを補正する
- **パラメータ調整**: スタビライゼーションの強度、スムージング、機能パラメータなどを調整できる
- **複数ソース対応**: 複数のビデオソースに同時に適用可能
- **即時反映**: 設定変更がリアルタイムで映像に反映される

### 1.2. アルゴリズム機能
- **特徴点検出**: `goodFeaturesToTrack()` で画像の特徴点を検出
- **オプティカルフロー**: `calcOpticalFlowPyrLK()` でフレーム間の動きを検出
- **モーション分類**: 動きのタイプ（揺れ、パン、ズームなど）を分類
- **適応的補正**: 動きの種類に応じて補正方法を切り替え
- **スムージング**: ガウシアンフィルタや移動平均で補正値を平滑化

### 1.3. UI機能
- **プロパティパネル**: OBSの標準UIでパラメータ調整
- **プリセット**: 用途別のプリセット保存・読み込み
- **メトリクス表示**: 処理時間、FPS、メモリ使用量などの表示

## 2. 非機能要件 (Non-Functional Requirements)

### 2.1. パフォーマンス (Performance)
- **処理遅延**: 1フレーム以内（33ms以下、30fps基準）
- **CPU使用率**: 全体のCPU使用率を5%以下に抑制
- **メモリ使用量**: 最小限のメモリ使用、メモリリークなし
- **対応解像度**: HD（1920x1080）、フルHD、4K対応

### 2.2. セキュリティ (Security)
- **外部ライブラリ**: OpenCVなどの脆弱性に対処
- **入力検証**: 不正な入力に対して堅牢性を確保
- **バッファオーバーフロー**: バッファオーバーフローを防止

### 2.3. 互換性 (Compatibility)
- **プラットフォーム**: Windows、macOS、Linux対応
- **OBSバージョン**: 最新版のOBS Studioに対応
- **OpenCVバージョン**: 4.5以上

### 2.4. メンテナンス性 (Maintainability)
- **モジュール化**: 機能追加やバグ修正が容易
- **ドキュメント**: コードコメント、APIドキュメント、ユーザーガイド
- **テストカバレッジ**: 80%以上の単体テストカバレッジ

### 2.5. 可用性 (Usability)
- **直感的なUI**: 一般ユーザーが理解しやすいUI
- **デフォルト設定**: 初期状態で最適なスタビライゼーションを実現
- **エラーハンドリング**: 明確なエラーメッセージと回復方法

## 3. 受け入れ基準 (Acceptance Criteria)

### 3.1. 機能的受け入れ基準
- [ ] 手振れ補正が視覚的に確認できる（明らかな揺れの低減）
- [ ] 設定画面からスタビライゼーションレベルを調整でき、リアルタイムで反映される
- [ ] 複数のビデオソースにフィルターを適用してもOBSがクラッシュしない
- [ ] フィルター適用時のCPU使用率増加が閾値（5%）以下
- [ ] Windows、macOS、Linuxの最新版OBSで基本動作が確認できる

### 3.2. 非機能的受け入れ基準
- [ ] 1920x1080 @ 30fpsで処理遅延が1フレーム（33ms）以内
- [ ] 連続24時間動作でメモリリークがない
- [ ] クラッシュや不正終了が発生しない
- [ ] テストスイートがすべてパスする（カバレッジ80%以上）
- [ ] コードが静的解析（cppcheck）でエラーなし

## 4. 設計方針 (Design Principles)

### 4.1. アーキテクチャ原則
- **OBSプラグイン**: OBSのフィルタープラグインとして実装
- **外部ライブラリ活用**: OpenCVなどの既存ライブラリを活用
- **標準UI**: OBSの標準UIフレームワークを使用
- **モジュール化**: 機能を独立したモジュールに分割

### 4.2. コーディング規約
- **YAGNI (You Aren't Gonna Need It)**: 今必要な機能だけ実装する
- **DRY (Don't Repeat Yourself)**: コードの重複を避ける
- **KISS (Keep It Simple, Stupid)**: シンプルに保つ
- **TDD**: テスト駆動開発

### 4.3. トレードオフ
- **精度 vs パフォーマンス**: 精度を上げると計算量が増え、CPU負荷が上がる。ユーザーがパラメータで調整できるようにする
- **ライブラリ使用 vs 自作実装**: OpenCVを使用すると開発時間が短縮されるが、ライブラリ依存になる。開発速度を優先し、OpenCVを使用する
- **リアルタイム vs 品質**: リアルタイム処理を優先し、品質を少し犠牲にする

## 5. アーキテクチャ決定 (Architecture Decisions)

### 5.1. 全体構成

```
┌─────────────────────────────────────────────────────────┐
│                    OBS Studio                        │
│                                                     │
│  ┌─────────────────────────────────────────────────┐   │
│  │         OBS Stabilizer Plugin                  │   │
│  │                                                 │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │  Plugin Interface (stabilizer_opencv)  │   │   │
│  │  │  - obs_source_info                   │   │   │
│  │  │  - Property callbacks                │   │   │
│  │  │  - Frame callbacks                  │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │           │                                     │   │
│  │           ▼                                     │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │    StabilizerWrapper (core/wrapper)   │   │   │
│  │  │  - Thread-safe interface             │   │   │
│  │  │  - State management                │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │           │                                     │   │
│  │           ▼                                     │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │  AdaptiveStabilizer (core/adaptive)  │   │   │
│  │  │  - Motion classification             │   │   │
│  │  │  - Mode selection                 │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │           │                                     │   │
│  │           ▼                                     │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │    StabilizerCore (core/core)        │   │   │
│  │  │  - Frame processing                │   │   │
│  │  │  - Smoothing algorithms            │   │   │
│  │  │  - Transform calculation          │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │           │                                     │   │
│  │           ▼                                     │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │  FeatureDetection (core/features)      │   │   │
│  │  │  - goodFeaturesToTrack              │   │   │
│  │  │  - calcOpticalFlowPyrLK            │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                 │   │
│  └─────────────────────────────────────────────────┘   │
│                                                     │
└─────────────────────────────────────────────────────────┘
```

### 5.2. コンポーネント説明

#### 5.2.1. Plugin Interface (`stabilizer_opencv.cpp`)
- 役割: OBSプラグインとしてのインターフェース
- 責任:
  - `obs_source_info` 構造体の定義
  - プロパティコールバック（設定UI）
  - フレームコールバック（映像処理）

#### 5.2.2. StabilizerWrapper (`stabilizer_wrapper.cpp`)
- 役割: スレッドセーフなラッパー
- 責任:
  - スレッドセーフなインターフェース提供
  - 状態管理
  - 初期化・クリーンアップ

#### 5.2.3. AdaptiveStabilizer (`adaptive_stabilizer.cpp`)
- 役割: 適応的スタビライゼーション
- 責任:
  - モーション分類
  - モード選択（パン、ズーム、揺れ）

#### 5.2.4. StabilizerCore (`stabilizer_core.cpp`)
- 役割: コア処理ロジック
- 責任:
  - フレーム処理
  - スムージングアルゴリズム
  - 変換行列の計算

#### 5.2.5. FeatureDetection (`feature_detection.cpp`)
- 役割: 特徴点検出とオプティカルフロー
- 責任:
  - `goodFeaturesToTrack()` での特徴点検出
  - `calcOpticalFlowPyrLK()` でのオプティカルフロー計算

#### 5.2.6. MotionClassifier (`motion_classifier.cpp`)
- 役割: 動きの分類
- 責任:
  - 動きベクトルの分析
  - パン、ズーム、揺れの分類

### 5.3. データフロー

```
OBS Frame (obs_source_frame)
    │
    ├─► Frame Utils (変換: obs_source_frame → cv::Mat)
    │
    ├─► Feature Detection (特徴点検出)
    │
    ├─► Optical Flow (オプティカルフロー計算)
    │
    ├─► Motion Classification (動き分類)
    │
    ├─► Adaptive Stabilizer (モード選択)
    │
    ├─► Stabilizer Core (スムージング、変換行列計算)
    │
    ├─► Transform Application (warpAffine / warpPerspective)
    │
    └─► Frame Utils (変換: cv::Mat → obs_source_frame)
            │
            └─► OBS Output
```

### 5.4. スレッドモデル

- **OBSスレッド**: プラグインのメインスレッド（フレーム処理）
- **UIスレッド**: OBSのUIスレッド（プロパティ更新）
- **スレッドセーフ**: `StabilizerWrapper` がスレッドセーフなインターフェースを提供

## 6. トレードオフの検討 (Trade-off Analysis)

### 6.1. Point Feature Matching vs SURF/ORB

| 項目 | Point Feature Matching | SURF/ORB |
|------|---------------------|-----------|
| 精度 | 中 | 高 |
| 計算コスト | 低 (1-4ms/frame) | 高 |
| メモリ使用量 | 低 | 高 |
| GPU加速 | 可能 | 可能 |
| **結論** | **採用** | 採用せず |

**理由**: リアルタイム性を重視し、Point Feature Matchingを採用

### 6.2. スムージングアルゴリズム

| 項目 | ガウシアン | 移動平均 | カルマン |
|------|----------|---------|--------|
| 精度 | 中 | 低 | 高 |
| 計算コスト | 低 | 低 | 高 |
| 実装難易度 | 低 | 低 | 高 |
| **結論** | **採用** | 採用せず | 将来検討 |

**理由**: バランスの良さと実装の簡潔さからガウシアンを採用

### 6.3. クロップ vs パディング

| 項目 | クロップ | パディング |
|------|--------|---------|
| 画質 | 良い | やや劣化 |
| 画角 | 変化あり | 変化なし |
| 計算コスト | 低 | 高 |
| **結論** | **デフォルト採用** | オプションとして提供 |

**理由**: パフォーマンスを重視し、クロップをデフォルトに

## 7. ビルド・テスト構成

### 7.1. ビルドシステム
- **CMake**: 3.16以上
- **ビルドツール**: Ninja (推奨)、Make
- **C++標準**: C++17

### 7.2. 依存ライブラリ
- **OpenCV**: 4.5以上 (core, imgproc, video, calib3d)
- **GTest**: 1.14.0以上（テスト用）
- **OBS**: OBS Studioライブラリ（実行時）

### 7.3. テスト構成
- **単体テスト**: Google Test (GTest)
- **統合テスト**: 全体フローのテスト
- **パフォーマンステスト**: ベンチマークツール
- **メモリリーク検出**: Valgrind / AddressSanitizer

### 7.4. CI/CD
- **GitHub Actions**: 自動テスト、静的解析
- **ワークフロー**:
  - Build OBS Stabilizer (ビルド)
  - Quality Assurance (テスト、カバレッジ、静的解析)
  - Performance Tests (ベンチマーク)
  - Feature Implementation Flow (事前チェック、単体テスト)

## 8. 開発スケジュール

### Phase 1: 基盤構築 (Week 1-2) ✅ 完了
- [x] OBSプラグインテンプレート設定
- [x] OpenCV統合
- [x] 基本的なVideo Filter実装
- [x] 性能検証プロトタイプ作成
- [x] テストフレームワーク設定

### Phase 2: コア機能実装 (Week 3-6) ✅ 完了
- [x] Point Feature Matching実装
- [x] スムージングアルゴリズム実装
- [x] エラーハンドリング標準化
- [x] 単体テスト実装

### Phase 3: UI/UX・品質保証 (Week 7-8) ✅ 完了
- [x] 設定パネル作成
- [x] パフォーマンステスト自動化
- [x] メモリ管理・リソース最適化
- [x] 統合テスト環境構築

### Phase 4: 最適化・リリース準備 (Week 9-10) - 現在
- [ ] パフォーマンス調整
- [ ] クロスプラットフォーム対応
- [ ] デバッグ・診断機能実装
- [ ] ドキュメント整備

### Phase 5: 本格運用準備 (Week 11-12)
- [ ] CI/CD パイプライン構築
- [ ] プラグイン配布・インストール機能
- [ ] セキュリティ・脆弱性対応
- [ ] コミュニティ・コントリビューション体制構築
