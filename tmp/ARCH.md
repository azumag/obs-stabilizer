# OBS Stabilizer Architecture Decision

## 1. 機能要件 (Functional Requirements)

### 1.1 コア機能
- **リアルタイム映像スタビライゼーション**: OBSのビデオソースに対してリアルタイムで手ブレ補正を適用
- **マルチソース対応**: 複数のビデオソースにフィルターを適用可能
- **パラメータ調整**: ユーザーが補正強度・平滑化半径・特徴点数などをリアルタイムで調整
- **プリセット機能**: Gaming/Streaming/Recordingの3種類のプリセット設定
- **エッジハンドリング**: Padding/Crop/Scaleの3モード対応

### 1.2 技術要件
- **アルゴリズム**: Lucas-Kanadeオプティカルフローによる動きベクトル検出
- **変換行列**: アフィン変換による手ブレ補正
- **平滑化**: 移動平均による変換行列の時系列平滑化

## 2. 非機能要件 (Non-Functional Requirements)

### 2.1 パフォーマンス
| 指標 | 目標値 | 現在値 |
|------|--------|--------|
| 処理レイテンシ | < 16ms (60fps) | ~4-8ms |
| メモリ使用量 | < 100MB | ~50MB |
| CPU増加率 | < 5% | ~2-3% |
| フレームドロップ | 0% | 0% |

### 2.2 セキュリティ
- 無効な入力フレームに対する堅牢性
- OpenCVの例外を適切にハンドリング
- メモリ安全（RAIIパターン使用）

### 2.3 互換性
- **プラットフォーム**: Windows 10/11, macOS 12+, Ubuntu 20.04+
- **OBSバージョン**: OBS Studio 28.0+
- **アーキテクチャ**: x86_64, ARM64 (Apple Silicon)

### 2.4 メンテナンス性
- モジュール化された設計
- 包括的なテストカバレッジ（173テスト）
- 詳細なコメントとドキュメント

## 3. 受け入れ基準 (Acceptance Criteria)

- [x] 手ブレが視覚的に軽減されること
- [x] 設定画面から補正レベルを調整可能
- [x] 複数ソース適用時にOBSがクラッシュしない
- [x] CPU使用率増加が5%以下
- [x] Windows/macOS/Linuxで動作確認済み
- [x] すべての単体テストが通過（173テスト）
- [x] 静的解析で重大な問題が検出されない

## 4. 設計方針 (Design Policy)

### 4.1 基本方針
1. **OBSフィルタープラグイン**として実装
2. **OpenCV**を活用した映像処理
3. **OBS標準UIフレームワーク**による設定画面
4. **RAIIパターン**によるメモリ安全の確保

### 4.2 設計原則
- **YAGNI**: 現在必要ない機能は実装しない
- **DRY**: コードの重複を排除
- **KISS**: シンプルな実装を維持
- **単一責任**: 各クラスは一つの責任のみ持つ

## 5. アーキテクチャ (Architecture)

### 5.1 レイヤー構成

```
┌─────────────────────────────────────────────────────────────┐
│                    OBS Studio Core                         │
│         (obs_source_frame, obs_properties, etc.)           │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│              OBS Integration Layer                          │
│  stabilizer_opencv.cpp                                      │
│  - フィルターの登録・破棄                                    │
│  - OBSフレームとOpenCV Matの変換                             │
│  - UIプロパティの定義                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│              StabilizerWrapper (RAII)                       │
│  - StabilizerCoreのラッパー                                  │
│  - 例外安全性の提供                                          │
│  - 自動リソース管理                                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│              StabilizerCore (Core Algorithm)                │
│  - 特徴点検出 (goodFeaturesToTrack)                         │
│  - オプティカルフロー (calcOpticalFlowPyrLK)                │
│  - 変換行列推定 (estimateAffinePartial2D)                   │
│  - 平滑化処理 (移動平均)                                     │
│  - エッジハンドリング                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│              Utilities                                      │
│  - frame_utils: フレーム変換ユーティリティ                   │
│  - parameter_validation: パラメータ検証                     │
│  - preset_manager: プリセット管理                           │
│  - benchmark: パフォーマンス計測                            │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 データフロー

```
OBS Frame → FrameUtils::obs_to_cv() → StabilizerCore::process_frame()
                                              ↓
                                   detect_features()
                                              ↓
                                   track_features() [Lucas-Kanade]
                                              ↓
                                   estimate_transform()
                                              ↓
                                   smooth_transforms()
                                              ↓
                                   apply_transform()
                                              ↓
                                   FrameUtils::cv_to_obs() → OBS Output
```

### 5.3 クラス構成

#### StabilizerCore
- **責任**: コアアルゴリズムの実装
- **公開メソッド**:
  - `initialize()`: 初期化
  - `process_frame()`: フレーム処理
  - `update_parameters()`: パラメータ更新
  - `reset()`: 状態リセット
- **内部メソッド**:
  - `detect_features()`: Shi-Tomasi特徴点検出
  - `track_features()`: Lucas-Kanade追跡
  - `estimate_transform()`: アフィン変換推定
  - `smooth_transforms()`: 移動平均平滑化

#### StabilizerWrapper
- **責任**: RAIIによるリソース管理
- **特徴**:
  - コピー・ムーブ禁止
  - 例外安全性の確保
  - OBSコールバック境界での安全性

#### FrameUtils
- **責任**: OBSフレームとOpenCV Matの変換
- **機能**:
  - BGRA ↔ BGR変換
  - スレッドセーフなバッファ管理
  - フレーム検証

## 6. トレードオフ検討 (Trade-offs)

### 6.1 パフォーマンス vs 精度

| 手法 | 精度 | 速度 | 採用理由 |
|------|------|------|----------|
| Lucas-Kanade | 中 | 速 (1-4ms) | **採用**: リアルタイムに最適 |
| SURF/ORB | 高 | 遅 (10-50ms) | 計算コストが高すぎる |
| Deep Learning | 最高 | 遅 (GPU必須) | 複雑すぎる、モデルサイズ問題 |

**決定**: Lucas-Kanadeオプティカルフローを採用
- リアルタイム性能を優先
- ユーザーがパラメータで調整可能

### 6.2 OpenCV vs 自作実装

| 観点 | OpenCV | 自作実装 |
|------|--------|----------|
| 開発時間 | 短い | 長い |
| 最適化 | SIMD対応済み | 自前実装必要 |
| 自由度 | 制限あり | 完全制御可能 |
| メンテナンス | コミュニティ依存 | 自己管理 |

**決定**: OpenCVを採用
- 開発速度を優先
- SIMD最適化済み
- 十分な性能（4-8ms/frame）

### 6.3 エッジハンドリング戦略

| モード | 利点 | 欠点 | 用途 |
|--------|------|------|------|
| Padding | 画質維持 | 黒枠発生 | デフォルト |
| Crop | 黒枠なし | 解像度低下 | 中央重視 |
| Scale | 全画面表示 | 歪み発生 | フルスクリーン |

**決定**: 3モードを実装しユーザー選択

### 6.4 メモリ管理戦略

| 手法 | 利点 | 欠点 |
|------|------|------|
| RAII | 安全・例外対応 | オーバーヘッド最小 |
| 生ポインタ | 最速 | リークリスク |
| スマートポインタ | 自動解放 | 若干のオーバーヘッド |

**決定**: RAII + スマートポインタ
- 安全性を最優先
- OBS環境での堅牢性確保

## 7. 実装済み機能 (Completed)

### 7.1 Phase 1: 基盤構築 ✅
- [x] OBSプラグインテンプレート設定
- [x] OpenCV統合
- [x] 基本的なVideo Filter実装
- [x] 性能検証プロトタイプ
- [x] テストフレームワーク設定

### 7.2 Phase 2: コア機能 ✅
- [x] Point Feature Matching実装
- [x] スムージングアルゴリズム実装
- [x] エラーハンドリング標準化
- [x] 単体テスト実装（173テスト）

### 7.3 Phase 3: UI/UX・品質保証 ✅
- [x] 設定パネル作成
- [x] パフォーマンステスト自動化
- [x] メモリ管理・リソース最適化
- [x] 統合テスト環境構築

## 8. 今後の検討事項 (Future Considerations)

### 8.1 リファクタリング候補
1. **Image Abstraction Layer** (#321)
   - OpenCVからの脱却準備
   - 他の画像処理ライブラリへの移行容易性

2. **UIロジック分離** (#314)
   - stabilizer_opencv.cppからUIコードを分離
   - テスタビリティ向上

3. **命名規則改善** (#320)
   - 変数名・関数名の一貫性向上

### 8.2 パフォーマンス改善
1. **GPU Acceleration** (#319)
   - OpenCL/CUDA対応の検討
   - 現在のCPU実装（4-8ms）からさらなる短縮

2. **フレームコピー削減** (#315)
   - 不要なMatコピーの排除
   - ゼロコピー変換の検討

### 8.3 ドキュメント・品質
1. **インラインドキュメント** (#318)
   - 詳細なコードコメントの追加

2. **アーキテクチャドキュメント更新** (#323, #316)
   - 現在の設計を反映

3. **スレッド安全性テスト** (#317)
   - マルチスレッド環境での検証

### 8.4 プラットフォーム対応
1. **macOSプラグイン読み込み修正** (#324)
   - 現在のビルド方法の見直し
   - @rpath設定の最適化

## 9. 技術スタック

| カテゴリ | 技術 |
|----------|------|
| 言語 | C++17 |
| ビルド | CMake 3.16+ |
| 映像処理 | OpenCV 4.5+ |
| JSON | nlohmann/json |
| テスト | Google Test |
| CI/CD | GitHub Actions |
| 静的解析 | cppcheck |
| カバレッジ | gcovr/lcov |

## 10. ディレクトリ構成

```
obs-stabilizer/
├── src/
│   ├── stabilizer_opencv.cpp      # OBS統合メイン
│   └── core/
│       ├── stabilizer_core.cpp/.hpp   # コアアルゴリズム
│       ├── stabilizer_wrapper.cpp/.hpp # RAIIラッパー
│       ├── frame_utils.cpp/.hpp       # フレーム変換
│       ├── preset_manager.cpp/.hpp    # プリセット管理
│       ├── benchmark.cpp/.hpp         # パフォーマンス計測
│       ├── parameter_validation.hpp   # パラメータ検証
│       ├── stabilizer_constants.hpp   # 定数定義
│       └── logging.hpp                # ロギングユーティリティ
├── tests/                         # 単体テスト（173テスト）
├── tools/                         # ベンチマークツール
├── .github/workflows/             # CI/CD
├── docs/                          # ドキュメント
└── tmp/                           # 一時ファイル
```

---

**作成日**: 2026-02-16
**ステータス**: アーキテクチャ決定完了
**次のアクション**: STATE.mdをPLANNEDに更新し、実装委任
